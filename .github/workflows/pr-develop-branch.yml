name: Validar PR na OrganizaÃ§Ã£o Conectada a Branch de Desenvolvimento

# Parametros de quando irÃ¡ executor a aÃ§Ã£o
on:
  pull_request:
    types: [opened, synchronize]
    # IrÃ¡ executar somente em um PR para a branch de "develop"
    branches: [develop]
    # Executar sempre que houver alteraÃ§Ãµes no path abaixo
    paths:
      - "force-app/**"

# Trabalhos a serem executados
jobs:
  validar-pacote-na-organizacao-de-develop:
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'dependabot[bot]' }}
    steps:
      - uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: "Conferir cÃ³digo fonte"
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: "Ler corpo do PR e extrair classes de teste"
        env:
          PR_BODY: ${{github.event.pull_request.body}}

        run: |
          echo $PR_BODY > ./.process/pr_body.txt
          node ./.process/parsePR.js              
          TESTS=$(cat ./.process/testsToRun.txt)       
          echo "APEX_TESTS=$TESTS" >> $GITHUB_ENV

      - name: "IntalaÃ§Ã£o Salesforce CLI"
        run: |
          npm install @salesforce/cli --global
          sf --version

      - name: "InstalaÃ§Ã£o Scanner"
        run: sf plugins:install @salesforce/sfdx-scanner

      - name: "InstalaÃ§Ã£o do Git Delta"
        run: |
          echo y | sf plugins:install sfdx-git-delta

      - name: "InstalaÃ§Ã£o do Java"
        run: |
          sudo apt-get update
          sudo apt install default-jdk

      # Comando para obter URL de autenticaÃ§Ã£o -> sfdx force:org:display -u my-scratch-org --verbose
      - name: "Criar arquivo com URL de autenticaÃ§Ã£o"
        shell: bash
        run: |
          echo ${{ secrets.SF_DEVELOP_URL}} > ./SF_DEVELOP_URL.txt

      - name: "Autenticar na OrganizaÃ§Ã£o"
        run: sf org login sfdx-url -f ./SF_DEVELOP_URL.txt --set-default --alias develop

      - name: "Criar um pacote de alteraÃ§Ãµes"
        run: |
          mkdir changed-sources
          sfdx sgd:source:delta --to "HEAD" --from "HEAD^" --output changed-sources/ --generate-delta --source force-app/

      - name: "Scannear CÃ³digo"
        run: |
              ls -la &&
              cd "changed-sources" &&
              ls -la &&
              sf scanner:run --format json --target './**/*.cls' --category "Design,Best Practices,Performance" --outfile 'apexScanResults.json' &&
              cd .. 
              node .process/generate_comment.js > comment.md
             

      - name: Comment on pull request
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ‘‹ Thanks for reporting!'
            })
    

      - name: "Realizar validaÃ§Ã£o com testes especificos"
        if: ${{ env.APEX_TESTS != 'all' }}
        run: 
          sf project deploy validate --manifest "changed-sources/package/package.xml" --pre-destructive-changes changed-sources/destructiveChanges/destructiveChanges.xml --test-level RunSpecifiedTests --tests ${{env.APEX_TESTS}} --json

      - name: "Realizar validaÃ§Ã£o com todos as classes de teste"
        if: ${{ env.APEX_TESTS == 'all' }}
        run: |
          sf project deploy validate --manifest "changed-sources/package/package.xml" --pre-destructive-changes changed-sources/destructiveChanges/destructiveChanges.xml --test-level RunLocalTests  --json
