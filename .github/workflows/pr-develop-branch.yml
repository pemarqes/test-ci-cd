name: Validar PR na Organização Conectada a Branch de Desenvolvimento

# Parametros de quando irá executor a ação
on:
  pull_request:
    types: [opened, synchronize]
    # Irá executar somente em um PR para a branch de "develop"
    branches: [develop]
    # Executar sempre que houver alterações no path abaixo
    paths:
      - "force-app/**"

# Trabalhos a serem executados
jobs:
  validar-pacote-na-organizacao-de-develop:
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'dependabot[bot]' }}
    steps:
      - uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: "Conferir código fonte"
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: "Ler corpo do PR e extrair classes de teste"
        env:
          PR_BODY: ${{github.event.pull_request.body}}

        run: |
          echo $PR_BODY > ./.process/pr_body.txt
          node ./.process/parsePR.js              
          TESTS=$(cat ./.process/testsToRun.txt)       
          echo "APEX_TESTS=$TESTS" >> $GITHUB_ENV

      - name: "Intalação Salesforce CLI"
        run: |
          npm install @salesforce/cli --global
          sf --version

      - name: "Instalação Scanner"
        run: sf plugins:install @salesforce/sfdx-scanner

      - name: "Instalação do Git Delta"
        run: |
          echo y | sf plugins:install sfdx-git-delta

      - name: "Instalação do Java"
        run: |
          sudo apt-get update
          sudo apt install default-jdk

      # Comando para obter URL de autenticação -> sfdx force:org:display -u my-scratch-org --verbose
      - name: "Criar arquivo com URL de autenticação"
        shell: bash
        run: |
          echo ${{ secrets.SF_DEVELOP_URL}} > ./SF_DEVELOP_URL.txt

      - name: "Autenticar na Organização"
        run: sf org login sfdx-url -f ./SF_DEVELOP_URL.txt --set-default --alias develop

      - name: "Criar um pacote de alterações"
        run: |
          mkdir changed-sources
          sfdx sgd:source:delta --to "HEAD" --from "HEAD^" --output changed-sources/ --generate-delta --source force-app/

      - name: "Scannear Código"
        run: ls -la
             cd "changed-sources"
             ls -la
             

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v1
        with:
          sarif_file: changed-sources/apexScanResults.sarif

      - name: "Realizar validação com testes especificos"
        if: ${{ env.APEX_TESTS != 'all' }}
        run: 
          sf project deploy validate --manifest "changed-sources/package/package.xml" --pre-destructive-changes changed-sources/destructiveChanges/destructiveChanges.xml --test-level RunSpecifiedTests --tests ${{env.APEX_TESTS}} --json

      - name: "Realizar validação com todos as classes de teste"
        if: ${{ env.APEX_TESTS == 'all' }}
        run: |
          sf project deploy validate --manifest "changed-sources/package/package.xml" --pre-destructive-changes changed-sources/destructiveChanges/destructiveChanges.xml --test-level RunLocalTests  --json
